---
title: "04 Performance Measures"
date: "2020-06-03"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

## Load the training & test dataset
```{r}
library(tidyverse)
# Modeling
library(parsnip)
# Pre-processing & Sampling
library(recipes)
library(rsample)
# Modeling Error Metrics
library(yardstick)
library(workflows)
library(tune)

product_data <- read_csv("./01_ml_fund_source/Business\ Decisions\ with\ Machine\ Learning/product_backorders.csv")
product_data2 <- product_data %>% 
  mutate(
      product_backorder = went_on_backorder %>% str_to_lower() %>% str_detect("yes") %>% as.numeric()
  ) %>% 
  select(-c(went_on_backorder))
glimpse(product_data)

split_obj<- initial_split(product_data2, prop = 0.75)
train_tbl<- training(split_obj)
test_tbl<- testing(split_obj)
```
## Specifiy the response and predictor variables
```{r}
recipe_obj <- recipe(product_backorder ~., data = train_tbl) %>% 
    step_zv(all_predictors()) %>% 
    step_dummy(all_nominal(),-all_outcomes()) %>%
    prep()
```

## run AutoML specifying the stopping criterion
```{r}
Sys.setenv(JAVA_HOME="/Library/Java/JavaVirtualMachines/jdk-9.0.4.jdk/Contents/Home")

library(h2o)
h2o.init()
```

```{r}
# Split data into a training and a validation data frame
# Setting the seed is just for reproducability
split_h2o <- h2o.splitFrame(as.h2o(train_tbl), ratios = c(0.75), seed = 42)
train_h2o <- split_h2o[[1]]
valid_h2o <- split_h2o[[2]]
test_h2o  <- as.h2o(test_tbl)

# Set the target and predictors
y <- "product_backorder"
x <- setdiff(names(train_h2o), y)
```

```{r}
automl_models_h2o <- h2o.automl(
  x = x,
  y = y,
  training_frame    = train_h2o,
  validation_frame  = valid_h2o,
  leaderboard_frame = test_h2o,
  max_runtime_secs  = 120,
  nfolds            = 5,
  stopping_metric = "mae", stopping_rounds = 3,
                        stopping_tolerance = 1e-2
)
```

# Leaderboard visualization
```{r}
#slotNames(automl_models_h2o)
automl_models_h2o@leaderboard 

summary(automl_models_h2o@leaderboard %>% 
              as_tibble() )
```

# Tune a model with grid search
```{r}
```
# Visualize the trade of between the precision and the recall and the optimal threshold
```{r}
```
# ROC Plot
```{r}
```
# Precision vs Recall Plot
```{r}
```
# Gain Plot
```{r}
```
# Lift Plot
```{r}
```
# Dashboard with cowplot
```{r}
```